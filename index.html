<html>
<head>
  <meta charset="utf-8" />
  <title>Map Visualisasi COVID</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- Load Leaflet from CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
  integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
  crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
  integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
  crossorigin=""></script>
<script
  src="https://code.jquery.com/jquery-3.4.1.js"
  integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
  crossorigin="anonymous"></script>

  <!-- Load Esri Leaflet from CDN -->
  <script src="https://unpkg.com/esri-leaflet@2.3.3/dist/esri-leaflet.js"
  integrity="sha512-cMQ5e58BDuu1pr9BQ/eGRn6HaR6Olh0ofcHFWe5XesdCITVuSBiBZZbhCijBe5ya238f/zMMRYIMIIg1jxv4sQ=="
  crossorigin=""></script>
<script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.min.js"></script>
         <script src="js/qgis2web_expressions.js"></script>
         <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet-control-geocoder.Geocoder.js"></script>
        <script src="js/leaflet-search.js"></script>

        <script src="data/Kelurahan_Baru_0.js"></script>
        <link rel="stylesheet" href="css/L.Icon.Pulse.css" />
        <script>
            (function(window) {

    L.Icon.Pulse = L.DivIcon.extend({

        options: {
            className: '',
            iconSize: [12,12],
            fillColor: 'red',
            color: 'red',
            animate: true,
            heartbeat: 1,
        },

        initialize: function (options) {
            L.setOptions(this,options);

            // css
            
            var uniqueClassName = 'lpi-'+ new Date().getTime()+'-'+Math.round(Math.random()*100000);

            var before = ['background-color: '+this.options.fillColor];

            var after = [

                'box-shadow: 0 0 6px 2px '+this.options.color,

                'animation: pulsate ' + this.options.heartbeat + 's ease-out',
                'animation-iteration-count: infinite',
                'animation-delay: '+ (this.options.heartbeat + .1) + 's',
            ];

            if (!this.options.animate){
                after.push('animation: none');
                after.push('box-shadow:none');
            }

            var css = [
                '.'+uniqueClassName+'{'+before.join(';')+';}',
                '.'+uniqueClassName+':after{'+after.join(';')+';}',
            ].join('');
 
            var el = document.createElement('style');
            if (el.styleSheet){
                el.styleSheet.cssText = css;
            } else {
                el.appendChild(document.createTextNode(css));
            }

            document.getElementsByTagName('head')[0].appendChild(el);

            // apply css class

            this.options.className = this.options.className+' leaflet-pulsing-icon '+uniqueClassName;

            // initialize icon
            
            L.DivIcon.prototype.initialize.call(this, options);
        
        }
    });

    L.icon.pulse = function (options) {
        return new L.Icon.Pulse(options);
    };


    L.Marker.Pulse = L.Marker.extend({
        initialize: function (latlng,options) {
            options.icon = L.icon.pulse(options);
            L.Marker.prototype.initialize.call(this, latlng, options);
        }
    });

    L.marker.pulse = function (latlng,options) {
        return new L.Marker.Pulse(latlng,options);
    };

})(window);
        </script>


  <style>
    body { margin:0; padding:0; }
    #map { position: absolute; top:0; bottom:0; right:0; left:0; }
    .info {
            padding: 16px 10px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            width: 200px;
            height: 240px;
        }
        .info h4 {
            margin: 0 0 5px;
            color: 'white';
        }
.label {
    
    color: green;
    fillColor: none;
    fillOpacity: 0;
    background-color: none;
    border-color: none;
    background: none;
    border: none;
    box-shadow: none;
    margin: 0px;
    cursor: none;
    direction: 'center';
    interactive: false;
    fill: false;
}
.leaflet-popup-tip-container {
    display: none;
} 
  </style>
</head>
<body>

<div id="map"></div>

<script>

    var Esri_WorldTopoMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Esri, Diskminfo Kota Pekanbaru, Politeknik Caltex Riau'
            });

    var map = L.map('map', {
                    center: [0.510138, 101.443340],
                    zoom: 12,
                 
                });
    L.esri.basemapLayer('Topographic').addTo(map);

    var highlightLayer;

    
    var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
    var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
        //Add labels layer
        var labelStyle = {
            color: 'pink',
            opacity: 0

        };
        var labelMarkerOptions = {
                opacity: 0,
                fillOpacity: 0,
                fillColor:'brown'
        };

    function informasiChart(e) {
        highlightLayer = e.target;
        kelurahan =e.target.feature.properties['Kelurahan'].toLocaleString();  
        var labels = ['ODP', 'PDP','POSITIF'];
        if (typeof DATA_MONITORING[kelurahan] != "undefined")
            var data = [DATA_MONITORING[kelurahan].ODP,DATA_MONITORING[kelurahan].PDP,DATA_MONITORING[kelurahan].POSITIF];
        else
            var data =[0,0,0]
        var reps = '<h4>Informasi Kelurahan </h4>';
                    reps += '<canvas id="myChart" width="10" height="10"></canvas>';
        //console.log(e.target.feature.properties['Kelurahan'].toLocaleString())  
              
        newChart(kelurahan,labels, data);
        if (e.target.feature.geometry.type === 'LineString') {
            highlightLayer.setStyle({
                color: '#ffff00',
              });
        } else {
              highlightLayer.setStyle({
                 color: 'red'
              });
            }
    }
    function informasiKelurahan(feature, layer) {
        //layer.bindLabel(feature.properties['Kelurahan'].toLocaleString(), {noHide:true,direction:'right'});
        layer.on({
            mouseout: function(e) {
                for (i in e.target._eventParents) {
                    e.target._eventParents[i].resetStyle(e.target);
                }

            },
            mouseover: informasiChart,
        });
        var popupContent = '<table>\
                <tr>\
                    <th scope="row">Kelurahan</th>\
                    <td>' + (feature.properties['Kelurahan'] !== null ? autolinker.link(feature.properties['Kelurahan'].toLocaleString()) : '') + '</td>\
                </tr>\
                <tr>\
                    <td colspan="2">' + (feature.properties['Kecamatan'] !== null ? autolinker.link(feature.properties['Kecamatan'].toLocaleString()) : '') + '</td>\
                </tr>\
                <tr>\
                    <td colspan="2">' + (feature.properties['Luas'] !== null ? autolinker.link(feature.properties['Luas'].toLocaleString()) : '') + '</td>\
                </tr>\
                <tr>\
                    <td colspan="2">' + (feature.properties['Kota'] !== null ? autolinker.link(feature.properties['Kota'].toLocaleString()) : '') + '</td>\
                </tr>\
            </table>';
        layer.bindPopup(popupContent, {maxHeight: 400});
    }

    function getColor(b) {
        
        if (typeof DATA_MONITORING[b] != "undefined") {
            //console.log(b)
            if(DATA_MONITORING[b].POSITIF>=10)
                return '#000000'
            else if(DATA_MONITORING[b].POSITIF>=3)
                return '#8B0000'
            
            else if(DATA_MONITORING[b].POSITIF>=1)
                return 'rgba(255,0,0,1)'
            else if(DATA_MONITORING[b].PDP>=4)
                return '#FF7F00'
       ;
        }
        else{
            return '#99ff99'
        }
    }
    var getCentroid = function (arr) { 
        return arr.reduce(function (x,y) {
                return [x[0] + y[0]/arr.length, x[1] + y[1]/arr.length] 
        }, [0,0]) 
    }

    function warningKelurahanBerdasarkanStatus(feature) {
        var kelurahan =feature.properties['Kelurahan']
        var Warna = getColor(kelurahan)
        //jika ada positif kasi blink2
        if (typeof DATA_MONITORING[kelurahan] != "undefined" && feature.geometry.type == "MultiPolygon") {
            
            var koordinatBlink =  turf.centroid((feature.geometry))
            var pulsingIcon = L.icon.pulse({iconSize:[25,25],color:Warna,fillColor:Warna});
            var marker = L.marker([koordinatBlink.geometry.coordinates[1],koordinatBlink.geometry.coordinates[0]],{icon: pulsingIcon}).addTo(map);

        }
/*
        //marker latlng
       

*/
  
         return {
            pane: 'pane_Kelurahan',
            opacity: 0.8,
            color: 'rgba(0,0,0,1)',
            dashArray: '',
            lineCap: 'butt',
            lineJoin: 'miter',
            weight: 1.0, 
            fill: true,
            fillOpacity: 0.2,
            fillColor: Warna, //ganti sesuai data
            interactive: true,
        }
       
    }
    function newChart(Kelurahan,labels, data) {
            var dataLength = labels ? labels.length : 0;
            var backgroundColors = ['#FFC107',
                                    '#A9E5A9',
                                    '#E40000',
                                    'rgba(211,156,131, 0.9)',
                                    'rgba(153, 102, 255, 0.9)',
                                    'rgba(255, 159, 64, 0.9)'];
            var colors = [];
            for (var i = 0; i < dataLength; i++) {
                colors.push(backgroundColors[i]);
            };
            var ctx = document.getElementById("myChart");
            $("#judulChart").html("Data Monitoring Kelurahan<br>"+Kelurahan)
            var myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '# orang',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero:true
                            }
                        }]
                    }
                }
            });
        };
    var DATA_MONITORING={
        "Simpang Empat":{
            ODP:10,
            PDP:40,
            POSITIF:1
        },
        "Sungai Ambang":{
            ODP:150,
            PDP:4,
            POSITIF:0
        },
        "Metangor":{
            ODP:40,
            PDP:4,
            POSITIF:1
        },
        "Industri Tenayan":{
            ODP:120,
            PDP:4,
            POSITIF:1
        },            
        "Lembah Damai":{
            ODP:100,
            PDP:4,
            POSITIF:1
        },            
        "Metangor":{
            ODP:100,
            PDP:4,
            POSITIF:3
        },
        "Tebing Tinggi Okura":{
            ODP:100,
            PDP:4,
            POSITIF:0
        },
        "Tuah Madani":{
            ODP:100,
            PDP:4,
            POSITIF:3
        },
    }


        map.createPane('pane_Kelurahan');
        map.getPane('pane_Kelurahan').style.zIndex = 400;
        map.getPane('pane_Kelurahan').style['mix-blend-mode'] = 'normal';
        var layer_Kelurahan = new L.geoJson(json_Kelurahan_Baru_0, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Kelurahan_Baru_0',
            layerName: 'layer_Kelurahan',
            pane: 'pane_Kelurahan',
            onEachFeature: informasiKelurahan,
            style: warningKelurahanBerdasarkanStatus,
        });
        bounds_group.addLayer(layer_Kelurahan);
        map.addLayer(layer_Kelurahan);


        layer_Kelurahan.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            if(layer.feature.properties['Kelurahan'] !== null)
                if (typeof DATA_MONITORING[layer.feature.properties['Kelurahan']] != "undefined")
                    layer.bindTooltip((layer.feature.properties['Kelurahan'] !== null?String('<div style="color: #000000; font-size: 10pt; font-family: \'MS UI Gothic\', sans-serif;">' + layer.feature.properties['Kelurahan']) + '</div>':''), {permanent: true, offset: [-0, -26], className: 'label'});
            //labels.push(layer);
           
        });


      
        var info = L.control();

        info.onAdd = function(map) {
            this._div = L.DomUtil.create('div', 'info');
                                reps = '<h4 id="judulChart"></h4><canvas id="myChart" width="10" height="10"></canvas>';
            this._div.innerHTML = reps;
            return this._div;
        };
        info.addTo(map);




jQuery(document).ready(function($) {
        
});
        

      </script>

</body>
</html>