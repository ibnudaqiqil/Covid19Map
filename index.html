<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

 






  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- Load Leaflet from CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="  crossorigin=""/>
   <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"  integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="  crossorigin=""></script>
<script  src="https://code.jquery.com/jquery-3.4.1.js"  integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>

  <!-- Load Esri Leaflet from CDN -->
  <script src="https://unpkg.com/esri-leaflet@2.3.3/dist/esri-leaflet.js" integrity="sha512-cMQ5e58BDuu1pr9BQ/eGRn6HaR6Olh0ofcHFWe5XesdCITVuSBiBZZbhCijBe5ya238f/zMMRYIMIIg1jxv4sQ=="  crossorigin=""></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.min.js"></script>
         <script src="js/qgis2web_expressions.js"></script>
         <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet-control-geocoder.Geocoder.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="js/chroma.min.js"></script>
        <script src="js/L.Icon.Pulse.js"></script>

        <script src="data/Kelurahan_Baru_1.js"></script>
        <link rel="stylesheet" href="css/L.Icon.Pulse.css" />
        <link rel="stylesheet" href="css/mobile.css">
        <link rel="stylesheet" href="css/main.css">
        


  <style>
    body { margin:0; padding:0; }
    #map { position: absolute; top:0; bottom:0; right:0; left:0; }
    .info {
            padding: 16px 10px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            width: 200px;
            height: 240px;
        }
        .info h4 {
            margin: 0 0 5px;
            color: 'white';
        }
.label {
    
    color: green;
    fillColor: none;
    fillOpacity: 0;
    background-color: none;
    border-color: none;
    background: none;
    border: none;
    box-shadow: none;
    margin: 0px;
    cursor: none;
    direction: 'center';
    interactive: false;
    fill: false;
}
.leaflet-popup-tip-container {
    display: none;
} 
#graph-container
{
  height: 300px;
}
 </style>
</head>
<body>
    <div id="map"></div>


    
    <div id="info" class="">
        <div class="simplebar-wrapper">
            <div id="title">
                  COVID-19 Monitoring Map
            </div>
            <div><span id="last-date">Last update: </span><span id="date">2020-04-15 22:33:51 PST</span> </div>




            <div class="row">
                <div class="col-lg-4 col-md-4 col-sm-6 border text-white bg-info pt-3 mb-1">
                    <div class="row">
                        <div class="col-lg-12 col-md-12 col-sm-12">
                            <h5 class="card-title text-white text-center">Orang Dalam Pemantauan (ODP) </h5>
                            <br>
                        </div>
                    </div>
                    <div class="row border border-left-0 border-right-0">
                        <div class="col-lg-12 col-md-12 col-sm-12" style="padding: 2px;">
                        Proses Pemantauan : <br>
                        Selesai Pemantauan :<br>
                        <br>
                    </div>

                    </div>
                    <div class="row">
                        <div class="col-lg-12 col-md-12 col-sm-12">
                            <h6 class="text-center pt-1">Total ODP</h6>
                            <h6 class="card-subtitle mb-2 text-center pt-1" style="font-size: 25px;">3549 <small>(96.62%)</small></h6>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-4 col-sm-6 border bg-warning text-white pt-3 mb-1">
                    <div class="row">
                        <div class="col-lg-12 col-md-12 col-sm-12">
                            <h5 class="card-title text-white text-center">Pasien Dalam Pengawasan (PDP)</h5><br>
                        </div>
                    </div>
                    <div class="row border border-left-0 border-right-0">
                        <div class="col-lg-12 col-md-12 col-sm-12" style="padding: 2px;">
                        Dirawat : <br>
                        Meninggal : <br>
                        Sembuh :
                        </div>

                    </div>
                    <div class="row">
                        <div class="col-lg-12 col-md-12 col-sm-12">
                            <h6 class="text-center pt-1">Total PDP</h6>
                            <h6 class="card-subtitle mb-2 text-center" style="font-size: 25px;">113                                                        <small>(3.08%)</small></h6>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-4 border col-sm-6 bg-danger text-white pt-3 mb-1">
                    <div class="row">
                        <div class="col-lg-12 col-md-12 col-sm-12">
                            <h5 class="card-title text-white text-center">Kasus Positif Covid-19/Corona</h5><br>
                        </div>
                    </div>
                    <div class="row border border-left-0 border-right-0">
                        <div class="col-lg-12 col-md-12 col-sm-12" style="padding: 2px;">
                        Dirawat : <br>
                        Meninggal : <br>
                        Sembuh :
                    </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12 col-md-12 col-sm-12">
                            <h6 class="text-center pt-1">Total Positif COVID-19</h6>
                            <h6 class="card-subtitle mb-2 text-center" style="font-size: 25px;">11                                                        <small>(0.3%)</small>
                            </h6>
                        </div>
                    </div>
                </div>
            </div>

            <div id="grafik">
             <strong id="judulChart"></strong>
             <div id="graph-container"><canvas id="myChart" width="10" height="10"></canvas></div>
            </div>
        </div>
        
    </div>
            <div id="legend-panel" class="card-deck legend">

              <div class="card">
                <div class="card-body">
                  <h5 class="card-title grey-circles" style="color:black">no case</h5>
                </div>
              </div>

              <div class="card">
                <div class="card-body legend-color-1">
                  <h5 class="card-title" style="color:black">1</h5>

                </div>
              </div>

              <div class="card">
                <div class="card-body legend-color-2">
                  <h5 class="card-title" style="color:black">100</h5>

                </div>
              </div>
              <div class="card">
                <div class="card-body  legend-color-3">
                  <h5 class="card-title" style="color:black">1,000</h5>
                </div>
              </div>

              <div class="card">
                <div class="card-body  legend-color-4">
                  <h5 class="card-title" style="color:black">5,000</h5>

                </div>
              </div>

              <div class="card">
                <div class="card-body legend-color-5">
                  <h5 class="card-title" style="color:black">10,000</h5>
                </div>
              </div>

              <div class="card">
                <div class="card-body legend-color-6">
                  <h5 class="card-title" style="color:black">50,000+</h5>
                </div>
              </div>
            </div> 
<!-- /container -->


<script>
    var RS_RUJUKAN = "https://services5.arcgis.com/VS6HdKS0VfIhv8Ct/ArcGIS/rest/services/RS_Rujukan_COVID19_Indonesia/FeatureServer/0"
    var Esri_WorldTopoMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Esri, Diskminfo Kota Pekanbaru, Politeknik Caltex Riau'
            });
  

    var gray = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png');
    // var dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png').addTo(mymap);
   

    var map = L.map('map', {
                    center: [0.530138, 101.4],
                    zoom: 12,
                 
                });

     var gray = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png');
    // var dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png').addTo(mymap);
    var voyager =
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}@2x.png').addTo(map);
    var satellite =
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    var baseLayers = {
      'CARTO Light': gray,
      'Esri Topo': Esri_WorldTopoMap,
      'CARTO Voyager': voyager,
      'ESRI Satellite': satellite
    }

    L.esri.basemapLayer('Topographic').addTo(map);
    L.control.zoom({
        position: 'bottomright'
    }).addTo(map);
     var ICON_RS = L.icon({
        iconUrl: 'markers/hospital-building.png',
        iconSize: [27, 31],
        iconAnchor: [13.5, 17.5],
        popupAnchor: [0, -11]
      });
    var layer_rs = L.esri.featureLayer({ 
        url: RS_RUJUKAN,
        pointToLayer: function (geojson, latlng) {
            return L.marker(latlng, {
                icon: ICON_RS
            });
        }
    }).addTo(map);

    var highlightLayer;
    //create colot scale for both region and legend,and insert the "style" into the "head" tag
    var warnaPeta = chroma.scale('YlOrRd').mode('lch').colors(6);
    for (i = 0; i < 6; i++) {
      $('head').append($("<style> .region-color-" + (i + 1).toString() + " { color: " + warnaPeta[i] + "; font-size: 15px; text-shadow: 0 0 3px #ffffff;} </style>"));
      $('head').append($("<style> .legend-color-" + (i + 1).toString() + " { background: " + warnaPeta[i] + "; font-size: 15px; text-shadow: 0 0 3px #ffffff;} </style>"));
    }

    
    var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
    var bounds_group = new L.featureGroup([]);
    function setBounds() {

    }
    //Add labels layer
    var labelStyle = {
        color: 'pink',
        opacity: 0

    };
    var labelMarkerOptions = {
            opacity: 0,
            fillOpacity: 0,
            fillColor:'brown'
    };

    function informasiChart(e) {
        highlightLayer = e.target;
        kelurahan =e.target.feature.properties['Kelurahan'].toLocaleString();  
        var labels = ['ODP', 'PDP','POSITIF'];
        console.log(e.target.feature)
        if (typeof DATA_MONITORING[kelurahan] != "undefined"){
            var data = [DATA_MONITORING[kelurahan].ODP,DATA_MONITORING[kelurahan].PDP,DATA_MONITORING[kelurahan].POSITIF];
            newChart(kelurahan,labels, data);
        }
        else
        {
            var data =[0,0,0]
             $("#judulChart").html("")
             //$("#myChart").html("")
              $('#myChart').remove(); // this is my <canvas> element
              $('#graph-container').append('<canvas id="myChart"><canvas>');
        }
        
        //console.log(e.target.feature.properties['Kelurahan'].toLocaleString())  
              
        
        highlightLayer.setStyle({
          weight: 2,
          opacity: 0.8,
          color: '#e3e3e3',
          fillColor: '#00ffd9',
          fillOpacity: 0.1
        });
    }
    function informasiKelurahan(feature, layer) {
        //layer.bindLabel(feature.properties['Kelurahan'].toLocaleString(), {noHide:true,direction:'right'});
        layer.on({
            mouseout: function(e) {
                for (i in e.target._eventParents) {
                    e.target._eventParents[i].resetStyle(e.target);
                }

            },
            mouseover: informasiChart,
        });
        kelurahan = feature.properties['Kelurahan']
        if (typeof DATA_MONITORING[kelurahan] != "undefined"){
            var ODP = DATA_MONITORING[kelurahan].ODP
            var PDP = DATA_MONITORING[kelurahan].ODP
            var POSITIF = DATA_MONITORING[kelurahan].POSITIF

        }
        else
        {
            var ODP=0;
            var PDP=0;
            var POSITIF=0;
        }
        var popupContent = '<table>\
                <tr>\
                    <th scope="row">Kelurahan</th>\
                    <td>' + (feature.properties['Kelurahan'] !== null ? autolinker.link(feature.properties['Kelurahan'].toLocaleString()) : '') + '</td>\
                </tr>\
                <tr>\
                    <th scope="row">Kecamatan</th>\
                    <td>' + (feature.properties['Kecamatan'] !== null ? autolinker.link(feature.properties['Kecamatan'].toLocaleString()) : '') + '</td>\
                </tr>\
                <tr>\
                    <th scope="row">ODP</th>\
                    <td>' + ODP + '</td>\
                </tr>\
                 <tr>\
                    <th scope="row">PDP</th>\
                    <td>' + PDP + '</td>\
                </tr>\
                <tr>\
                    <th scope="row">POSITIF</th>\
                    <td>' + POSITIF + '</td>\
                    </tr>\
            </table>';
        layer.bindPopup(popupContent, {maxHeight: 400});
    }

    function getColor(b) {
        
        if (typeof DATA_MONITORING[b] != "undefined") {
            //console.log(b)
            if(DATA_MONITORING[b].POSITIF>=10)
                return warnaPeta[5]
            else if(DATA_MONITORING[b].POSITIF>=3)
                return warnaPeta[4]
            
            else if(DATA_MONITORING[b].POSITIF>=1)
                return warnaPeta[3]
            else if(DATA_MONITORING[b].PDP>=4)
                return warnaPeta[2]
             else if(DATA_MONITORING[b].ODP>=0)
                return warnaPeta[1]
       ;
        }
        else{
            return warnaPeta[0]
            //return '#99ff99'
        }
    }

    var getCentroid = function (arr) { 
        return arr.reduce(function (x,y) {
                return [x[0] + y[0]/arr.length, x[1] + y[1]/arr.length] 
        }, [0,0]) 
    }

    function warningKelurahanBerdasarkanStatus(feature) {
        var kelurahan =feature.properties['Kelurahan']
        var Warna = getColor(kelurahan)
        //jika ada positif kasi blink2
         //console.log(feature)
        if (typeof DATA_MONITORING[kelurahan] != "undefined" && feature.geometry.type == "Polygon") {
            //console.log(feature)
            if(DATA_MONITORING[kelurahan].POSITIF>=10)
                getar=1
            else if(DATA_MONITORING[kelurahan].POSITIF>0)
                getar=2
            else if (DATA_MONITORING[kelurahan].PDP>0){
                getar=3               
            }
             else if (DATA_MONITORING[kelurahan].ODP>0){
                getar=5
                console.log(feature)
            }
            else
                getar=6
            var koordinatBlink =  turf.centroid((feature.geometry))
            var pulsingIcon = L.icon.pulse({iconSize:[25,25],color:Warna,fillColor:Warna,heartbeat:getar});
            var marker = L.marker([koordinatBlink.geometry.coordinates[1],koordinatBlink.geometry.coordinates[0]],{icon: pulsingIcon}).addTo(map);

        }
         return {
            pane: 'pane_Kelurahan',
            opacity: 0.8,
            color: '#b3b3b3',
            dashArray: '',
            lineCap: 'butt',
            lineJoin: 'miter',
            weight: 1.0, 
            fill: true,
            fillOpacity: 0.2,
            fillColor: Warna, //ganti sesuai data
            interactive: true,
        }
       
    }


    function newChart(Kelurahan,labels, data) {
        var dataLength = labels ? labels.length : 0;
        var backgroundColors = ['#6c757d',
                                '#ffc107',
                                '#dc3545',
                                'rgba(211,156,131, 0.9)',
                                'rgba(153, 102, 255, 0.9)',
                                'rgba(255, 159, 64, 0.9)'];
        var colors = [];
        for (var i = 0; i < dataLength; i++) {
            colors.push(backgroundColors[i]);
        };
        var ctx = document.getElementById("myChart");
        $("#judulChart").html("Data Monitoring Kelurahan<br>"+Kelurahan)
        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '# orang',
                    data: data,
                    backgroundColor: colors,
                    borderColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero:true
                        }
                    }]
                }
            }
        });
    };
    var DATA_MONITORING={
        "Simpang Empat":{
            ODP:10,
            PDP:40,
            POSITIF:1
        },
        "Sungai Ambang":{
            ODP:150,
            PDP:4,
            POSITIF:0
        },
        "Metangor":{
            ODP:40,
            PDP:4,
            POSITIF:1
        },
        "Industri Tenayan":{
            ODP:120,
            PDP:4,
            POSITIF:1
        },            
        "Lembah Damai":{
            ODP:100,
            PDP:4,
            POSITIF:1
        },            
        "Metangor":{
            ODP:100,
            PDP:4,
            POSITIF:3
        },
        "Tebing Tinggi Okura":{
            ODP:100,
            PDP:4,
            POSITIF:0
        },
        "Tuah Madani":{
            ODP:100,
            PDP:4,
            POSITIF:13
        },
        "Palas":{
            ODP:100,
            PDP:0,
            POSITIF:0
        },
    }


        map.createPane('pane_Kelurahan');
        map.getPane('pane_Kelurahan').style.zIndex = 400;
        map.getPane('pane_Kelurahan').style['mix-blend-mode'] = 'normal';
        var layer_Kelurahan = new L.geoJson(json_Kelurahan_Baru_0, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Kelurahan_Baru_0',
            layerName: 'layer_Kelurahan',
            pane: 'pane_Kelurahan',
            onEachFeature: informasiKelurahan,
            style: warningKelurahanBerdasarkanStatus,
        });

        var layer_kecamatan = 
        bounds_group.addLayer(layer_Kelurahan);
        map.addLayer(layer_Kelurahan);


        layer_Kelurahan.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            if(layer.feature.properties['Kelurahan'] !== null)
                if (typeof DATA_MONITORING[layer.feature.properties['Kelurahan']] != "undefined")
                    layer.bindTooltip((layer.feature.properties['Kelurahan'] !== null?String('<div style="color: #000000; font-size: 10pt; font-family: \'MS UI Gothic\', sans-serif;">' + layer.feature.properties['Kelurahan']) + '</div>':''), {permanent: true, offset: [-0, -26], className: 'label'});
            //labels.push(layer);
           
        });

        new L.control.layers(baseLayers, {
        "Sebaran Kelurahan": layer_Kelurahan,
        "Rumah Sakit Rujukan": layer_rs
        //"Infected Community &nbsp;&nbsp; <i class='fas fa-procedures' style='color: #dc3545;'></i>": communities
      }, {
        collapsed: false
      }).addTo(map);

/*
      
        var info = L.control();

        info.onAdd = function(map) {
            this._div = L.DomUtil.create('div', 'info');
                                reps = '';
            this._div.innerHTML = reps;
            return this._div;
        };
        info.addTo(map);
*/


jQuery(document).ready(function($) {
        
});
        

      </script>
   
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
  </body>
</html>
